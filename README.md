# RAG æ£€ç´¢å¢å¼ºç”Ÿæˆç³»ç»Ÿ

ä¸€ä¸ªåŸºäº Milvus å‘é‡æ•°æ®åº“çš„æ™ºèƒ½æ–‡æ¡£æ£€ç´¢å¢å¼ºç”Ÿæˆ(RAG)ç³»ç»Ÿï¼Œä¸“ä¸ºPDFæ–‡æ¡£å¤„ç†å’Œæ™ºèƒ½é—®ç­”è€Œè®¾è®¡ã€‚æ”¯æŒæ–‡æ¡£è§£æã€å‘é‡åŒ–å­˜å‚¨ã€è¯­ä¹‰æœç´¢ã€å¤šè½®é—®ç­”ç­‰å®Œæ•´çš„RAGæµç¨‹ã€‚

## âœ¨ æ ¸å¿ƒç‰¹æ€§

- **æ™ºèƒ½PDFè§£æ**: åŸºäºLangChainçš„PDFè¯­ä¹‰åˆ†å‰²ï¼Œä¿æŒæ–‡æ¡£ç»“æ„å’Œè¯­ä¹‰å®Œæ•´æ€§
- **é«˜æ•ˆå‘é‡å­˜å‚¨**: ä½¿ç”¨Milvus Liteæ•°æ®åº“è¿›è¡Œå‘é‡åŒ–æ–‡æœ¬å­˜å‚¨å’Œå¿«é€Ÿæ£€ç´¢
- **æ™ºèƒ½æ–‡æœ¬åˆ†å‰²**: æ”¯æŒå¤æ‚é—®é¢˜çš„è‡ªåŠ¨åˆ†è§£å’Œå¤šè§’åº¦æŸ¥è¯¢
- **é‡æ’åºä¼˜åŒ–**: é›†æˆé‡æ’åºç®—æ³•æå‡æ£€ç´¢ç»“æœçš„ç›¸å…³æ€§å’Œå‡†ç¡®æ€§
- **å¤šæ¨¡å‹æ”¯æŒ**: é›†æˆSiliconFlow APIï¼Œæ”¯æŒå¤šç§å¤§è¯­è¨€æ¨¡å‹å’ŒåµŒå…¥æ¨¡å‹
- **å‘½ä»¤è¡Œç•Œé¢**: æä¾›ä¾¿æ·çš„CLIå·¥å…·ï¼Œæ”¯æŒæ–‡æ¡£åŠ è½½ã€æŸ¥è¯¢ã€æ¸…ç†ç­‰æ“ä½œ
- **å¹¶å‘å¤„ç†**: æ”¯æŒå¤§è§„æ¨¡æ–‡æ¡£çš„é«˜æ•ˆæ‰¹é‡å¤„ç†

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
RAG ç³»ç»Ÿæµç¨‹:
PDFæ–‡æ¡£ â†’ æ™ºèƒ½è§£æ â†’ æ–‡æœ¬åˆ†å‰² â†’ å‘é‡åŒ– â†’ Milvuså­˜å‚¨
                â†“
ç”¨æˆ·é—®é¢˜ â†’ é—®é¢˜åˆ†è§£ â†’ å‘é‡æ£€ç´¢ â†’ é‡æ’åº â†’ å¤§æ¨¡å‹ç”Ÿæˆ â†’ ç­”æ¡ˆè¾“å‡º
```
## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Python >= 3.12
- UV åŒ…ç®¡ç†å™¨ (æ¨è) æˆ– pip

### å®‰è£…ä¾èµ–

ä½¿ç”¨ UV (æ¨è):
```bash
# å…‹éš†é¡¹ç›®
git clone <repository-url>
cd RAG

# å®‰è£…ä¾èµ–
uv sync
```

ä½¿ç”¨ pip:
```bash
pip install bs4 langchain-community openai pdfminer-six pymilvus requests
```

### ç¯å¢ƒå˜é‡é…ç½®

è®¾ç½®SiliconFlow APIå¯†é’¥ï¼š
```bash
export siliconflow_api_key="your_api_key_here"
```

### åŸºæœ¬ä½¿ç”¨

1. **åŠ è½½PDFæ–‡æ¡£**ï¼š
```bash
python main.py --load docs/example.pdf
```

2. **æŸ¥è¯¢æ–‡æ¡£å†…å®¹**ï¼š
```bash
python main.py --query "ä»€ä¹ˆæ˜¯STM32å¾®æ§åˆ¶å™¨çš„å¼•è„šé…ç½®ï¼Ÿ"
```

3. **å¤æ‚æŸ¥è¯¢ï¼ˆè‡ªåŠ¨é—®é¢˜åˆ†è§£ï¼‰**ï¼š
```bash
python main.py --query "STM32F103çš„å°è£…ç±»å‹å’Œå¼•è„šé…ç½®" --split
```

4. **æŒ‡å®šæ–‡æ¡£æŸ¥è¯¢**ï¼š
```bash
python main.py --query "GPIOé…ç½®æ–¹æ³•" --include docs/STM32F103x8.pdf
```

5. **æ¸…ç†æ•°æ®åº“**ï¼š
```bash
python main.py --clear
```

## ğŸ“ é¡¹ç›®ç»“æ„

```
RAG/
â”œâ”€â”€ main.py                    # ä¸»ç¨‹åºå…¥å£å’Œå‘½ä»¤è¡Œå·¥å…·
â”œâ”€â”€ pyproject.toml            # é¡¹ç›®é…ç½®å’Œä¾èµ–ç®¡ç†
â”œâ”€â”€ uv.lock                   # ä¾èµ–é”å®šæ–‡ä»¶
â”œâ”€â”€ milvus_rag.db            # Milvus æ•°æ®åº“æ–‡ä»¶
â”œâ”€â”€ README.md                # é¡¹ç›®è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ ans.md                   # æŸ¥è¯¢ç»“æœç¤ºä¾‹
â”œâ”€â”€ test.html                # PDFè§£ææµ‹è¯•æ–‡ä»¶
â”œâ”€â”€ docs/                    # æ–‡æ¡£ç›®å½•
â”‚   â”œâ”€â”€ STM32F103x8.pdf      # ç¤ºä¾‹PDFæ–‡æ¡£
â”‚   â””â”€â”€ *.md                 # æŠ€æœ¯æ–‡æ¡£å’ŒæŒ‡å—
â”œâ”€â”€ rag_modules/             # æ ¸å¿ƒRAGæ¨¡å—
â”‚   â”œâ”€â”€ __init__.py          # æ¨¡å—åˆå§‹åŒ–
â”‚   â”œâ”€â”€ clear.py             # æ•°æ®æ¸…ç†æ¨¡å—
â”‚   â”œâ”€â”€ embedding.py         # æ–‡æœ¬å‘é‡åŒ–æ¨¡å—
â”‚   â”œâ”€â”€ insert.py            # æ•°æ®æ’å…¥æ¨¡å—
â”‚   â”œâ”€â”€ pdf_manager.py       # PDFæ–‡æ¡£ç®¡ç†æ¨¡å—
â”‚   â”œâ”€â”€ refer.py             # å‚è€ƒæ–‡æ¡£è·å–æ¨¡å—
â”‚   â”œâ”€â”€ reranker.py          # é‡æ’åºæ¨¡å—
â”‚   â””â”€â”€ search.py            # æœç´¢æ¨¡å—
â””â”€â”€ utilties/                # å·¥å…·æ¨¡å—
    â”œâ”€â”€ __init__.py          # æ¨¡å—åˆå§‹åŒ–
    â”œâ”€â”€ load_pdf.py          # PDFåŠ è½½å’Œè§£æ
    â””â”€â”€ query.py             # æŸ¥è¯¢å¤„ç†å’Œç­”æ¡ˆç”Ÿæˆ
```

## ï¿½ æ ¸å¿ƒæ¨¡å—è¯¦è§£

### 1. `utilties/load_pdf.py` - PDFæ™ºèƒ½è§£ææ¨¡å—

ä¸“é—¨å¤„ç†PDFæ–‡æ¡£çš„è§£æå’Œè¯­ä¹‰åˆ†å‰²ï¼ŒåŸºäºLangChainçš„PDFMinerPDFasHTMLLoaderï¼š

**ä¸»è¦åŠŸèƒ½**:
- å°†PDFè½¬æ¢ä¸ºHTMLæ ¼å¼è¿›è¡Œè§£æ
- åŸºäºå­—ä½“å¤§å°è¯†åˆ«æ ‡é¢˜å’Œå†…å®¹å±‚æ¬¡
- è‡ªåŠ¨æ£€æµ‹é¡µé¢åˆ†éš”ç¬¦å¹¶ç»´æŠ¤é¡µç ä¿¡æ¯
- ç”Ÿæˆè¯­ä¹‰åˆ†å‰²çš„æ–‡æ¡£ç‰‡æ®µ

**ä½¿ç”¨ç¤ºä¾‹**:
```python
from utilties.load_pdf import load_pdf

# è§£æPDFæ–‡æ¡£
semantic_snippets = load_pdf("docs/STM32F103x8.pdf")

# æŸ¥çœ‹è§£æç»“æœ
for snippet in semantic_snippets:
    print(f"æ ‡é¢˜: {snippet.metadata['heading']}")
    print(f"é¡µç : {snippet.metadata['page_number']}")
    print(f"å†…å®¹: {snippet.page_content[:100]}...")
```

### 2. `utilties/query.py` - æŸ¥è¯¢å¤„ç†æ¨¡å—

è´Ÿè´£å¤„ç†ç”¨æˆ·æŸ¥è¯¢ã€é—®é¢˜åˆ†è§£å’Œç­”æ¡ˆç”Ÿæˆï¼š

**ä¸»è¦åŠŸèƒ½**:
- `split_query()`: æ™ºèƒ½åˆ†è§£å¤æ‚é—®é¢˜ä¸ºå¤šä¸ªå­é—®é¢˜
- `query_to_database()`: ä»æ•°æ®åº“æ£€ç´¢ç›¸å…³æ–‡æ¡£
- `ans()`: åŸºäºæ£€ç´¢ç»“æœç”Ÿæˆæœ€ç»ˆç­”æ¡ˆ

**ä½¿ç”¨ç¤ºä¾‹**:
```python
from utilties.query import split_query, query_to_database, ans

# åˆ†è§£å¤æ‚é—®é¢˜
questions = split_query("STM32F103çš„å¼•è„šé…ç½®å’ŒGPIOè®¾ç½®æ–¹æ³•")

# æ£€ç´¢ç›¸å…³æ–‡æ¡£
results = query_to_database("GPIOé…ç½®", ["STM32F103x8.pdf"])

# ç”Ÿæˆç­”æ¡ˆ
answer = ans(questions, results)
```

### 3. `rag_modules/embedding.py` - æ–‡æœ¬å‘é‡åŒ–æ¨¡å—

é«˜æ•ˆçš„æ–‡æœ¬å‘é‡åŒ–å¤„ç†ï¼Œæ”¯æŒå•ä¸ªå’Œæ‰¹é‡å¤„ç†ï¼š

**ä¸»è¦åŠŸèƒ½**:
- `get_embedding()`: å•ä¸ªæ–‡æœ¬å‘é‡åŒ–
- `get_batch_embeddings()`: æ‰¹é‡æ–‡æœ¬å‘é‡åŒ–
- `get_batch_embeddings_large_scale()`: å¤§è§„æ¨¡å¹¶å‘å‘é‡åŒ–

**æŠ€æœ¯ç‰¹æ€§**:
- ä½¿ç”¨Qwen3-Embedding-4Bæ¨¡å‹ï¼Œ768ç»´å‘é‡
- æ”¯æŒå¤šçº¿ç¨‹å¹¶å‘å¤„ç†
- è‡ªåŠ¨é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

### 4. `rag_modules/insert.py` - æ•°æ®æ’å…¥æ¨¡å—

è´Ÿè´£å°†å¤„ç†åçš„æ–‡æ¡£æ•°æ®æ’å…¥Milvusæ•°æ®åº“ï¼š

**æ•°æ®ç»“æ„**:
- `id`: å”¯ä¸€æ ‡è¯†ç¬¦ (INT64)
- `vector`: 768ç»´å‘é‡ (FLOAT_VECTOR)
- `text_content`: æ–‡æœ¬å†…å®¹ (VARCHAR)
- `pdf_name`: PDFæ–‡ä»¶å (VARCHAR)
- `page_number`: é¡µç  (INT64)
- `is_blocked`: å±è”½çŠ¶æ€ (BOOL) # å¼ƒç”¨,æš‚æœªåˆ é™¤

### 5. `rag_modules/search.py` - æ™ºèƒ½æœç´¢æ¨¡å—

æä¾›å¤šç§æœç´¢ç­–ç•¥å’Œè¿‡æ»¤åŠŸèƒ½ï¼š

**ä¸»è¦åŠŸèƒ½**:
- å‘é‡ç›¸ä¼¼åº¦æœç´¢
- å…ƒæ•°æ®è¿‡æ»¤
- å¤šæ¡ä»¶ç»„åˆæŸ¥è¯¢
- ç»“æœæ’åºå’Œä¼˜åŒ–

### 6. `rag_modules/refer.py` - å‚è€ƒæ–‡æ¡£è·å–æ¨¡å—

é›†æˆæœç´¢å’Œé‡æ’åºï¼Œæä¾›é«˜è´¨é‡çš„å‚è€ƒæ–‡æ¡£ï¼š

**å·¥ä½œæµç¨‹**:
1. å‘é‡æ£€ç´¢è·å–å€™é€‰æ–‡æ¡£
2. é‡æ’åºç®—æ³•ä¼˜åŒ–ç»“æœæ’åº
3. è¿‡æ»¤å’Œç­›é€‰æœ€ç›¸å…³çš„æ–‡æ¡£
4. è¿”å›ç»“æ„åŒ–çš„å‚è€ƒä¿¡æ¯

## ğŸ’¡ ä½¿ç”¨åœºæ™¯ç¤ºä¾‹

### åœºæ™¯1: æŠ€æœ¯æ–‡æ¡£é—®ç­”

```bash
# åŠ è½½æŠ€æœ¯æ–‡æ¡£
python main.py --load docs/STM32F103x8.pdf

# æŸ¥è¯¢å…·ä½“æŠ€æœ¯é—®é¢˜
python main.py --query "STM32F103çš„GPIOå¼•è„šå¦‚ä½•é…ç½®ä¸ºè¾“å‡ºæ¨¡å¼ï¼Ÿ"

# å¤æ‚æŠ€æœ¯é—®é¢˜åˆ†è§£æŸ¥è¯¢
python main.py --query "STM32F103çš„å°è£…ç±»å‹ã€å¼•è„šé…ç½®å’ŒGPIOè®¾ç½®æ–¹æ³•" --split
```

### åœºæ™¯2: å¤šæ–‡æ¡£å¯¹æ¯”åˆ†æ

```bash
# åŠ è½½å¤šä¸ªç›¸å…³æ–‡æ¡£
python main.py --load docs/doc1.pdf --load docs/doc2.pdf

# æŒ‡å®šæ–‡æ¡£èŒƒå›´æŸ¥è¯¢
python main.py --query "æ¯”è¾ƒä¸åŒå‹å·çš„ç‰¹æ€§" --include docs/doc1.pdf --include docs/doc2.pdf
```

### åœºæ™¯3: æ‰¹é‡æ–‡æ¡£å¤„ç†

```bash
# æ‰¹é‡åŠ è½½æ–‡æ¡£ç›®å½•
for file in docs/*.pdf; do
    python main.py --load "$file"
done

# è·¨æ–‡æ¡£æŸ¥è¯¢
python main.py --query "å¾®æ§åˆ¶å™¨çš„é€šç”¨ç‰¹æ€§"
```

## ğŸ¯ å®Œæ•´ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€RAGå·¥ä½œæµç¨‹

```python
# å®Œæ•´çš„RAGæµç¨‹ç¤ºä¾‹
from utilties.load_pdf import load_pdf
from rag_modules.insert import insert_data_with_metadata
from utilties.query import query_to_database, ans
from rag_modules.clear import clear_data

# 1. æ¸…ç†æ—§æ•°æ®
clear_data()

# 2. åŠ è½½å’Œè§£æPDFæ–‡æ¡£
semantic_snippets = load_pdf("docs/STM32F103x8.pdf")

# 3. å‡†å¤‡æ’å…¥æ•°æ®
texts = []
pdf_names = []
page_numbers = []

for snippet in semantic_snippets:
    texts.append(snippet.page_content)
    pdf_names.append("STM32F103x8.pdf")
    page_numbers.append(snippet.metadata['page_number'])

# 4. æ’å…¥æ•°æ®åˆ°å‘é‡æ•°æ®åº“
insert_data_with_metadata(
    texts=texts,
    pdf_names=pdf_names,
    page_numbers=page_numbers
)

# 5. æŸ¥è¯¢æ–‡æ¡£
question = "STM32F103çš„GPIOå¼•è„šå¦‚ä½•é…ç½®ï¼Ÿ"
references = query_to_database(question, ["STM32F103x8.pdf"])

# 6. ç”Ÿæˆç­”æ¡ˆ
final_answer = ans([question], references)
print(final_answer)
```

### å‘½ä»¤è¡Œå·¥å…·ä½¿ç”¨

ç³»ç»Ÿæä¾›äº†å¼ºå¤§çš„å‘½ä»¤è¡Œç•Œé¢ï¼Œæ”¯æŒä»¥ä¸‹æ“ä½œï¼š

```bash
# åŸºç¡€ç”¨æ³•
python main.py <command> [args]

# å¯ç”¨å‘½ä»¤:
--load <pdf_name>     # åŠ è½½PDFæ–‡æ¡£
--clear               # æ¸…ç†æ•°æ®åº“
--query <question>    # æŸ¥è¯¢é—®é¢˜
--include <pdf_name>  # æŒ‡å®šæŸ¥è¯¢èŒƒå›´
--split               # å¯ç”¨é—®é¢˜åˆ†è§£
```

**å®é™…ä½¿ç”¨ç¤ºä¾‹**:

```bash
# 1. åŠ è½½æ–‡æ¡£
python main.py --load docs/STM32F103x8.pdf

# 2. ç®€å•æŸ¥è¯¢
python main.py --query "ä»€ä¹ˆæ˜¯STM32F103ï¼Ÿ"

# 3. å¤æ‚æŸ¥è¯¢ï¼ˆè‡ªåŠ¨åˆ†è§£é—®é¢˜ï¼‰
python main.py --query "STM32F103çš„å¼•è„šé…ç½®å’ŒGPIOè®¾ç½®" --split

# 4. å¤šæ–‡æ¡£åŠ è½½
python main.py --load docs/doc1.pdf --load docs/doc2.pdf

# 5. æŒ‡å®šæ–‡æ¡£æŸ¥è¯¢
python main.py --query "GPIOé…ç½®æ–¹æ³•" --include docs/STM32F103x8.pdf

# 6. ç»„åˆå‘½ä»¤
python main.py --clear --load docs/new_doc.pdf --query "æ–°æ–‡æ¡£å†…å®¹æ‘˜è¦"
```

## âš™ï¸ é…ç½®è¯´æ˜

### æ¨¡å‹é…ç½®

- **åµŒå…¥æ¨¡å‹**: Qwen/Qwen3-Embedding-4B (768ç»´)
- **ç”Ÿæˆæ¨¡å‹**: moonshotai/Kimi-K2-Instruct (å¯é…ç½®)
- **é—®é¢˜åˆ†è§£æ¨¡å‹**: Qwen/Qwen3-30B-A3B (å¯é…ç½®)

### æ•°æ®åº“é…ç½®

- **æ•°æ®åº“ç±»å‹**: Milvus Lite
- **æ•°æ®åº“æ–‡ä»¶**: `milvus_rag.db`
- **é»˜è®¤é›†åˆ**: `rag_docs`
- **å‘é‡ç»´åº¦**: 768

### APIé…ç½®

éœ€è¦é…ç½®SiliconFlow APIå¯†é’¥ï¼š
```bash
export siliconflow_api_key="your_api_key_here"
```

## ğŸ” æŠ€æœ¯åŸç†

### æ–‡æ¡£å¤„ç†æµç¨‹

1. **PDFè§£æ**: ä½¿ç”¨PDFMineræå–PDFçš„HTMLè¡¨ç¤º
2. **è¯­ä¹‰åˆ†å‰²**: åŸºäºå­—ä½“å¤§å°å’Œå¸ƒå±€è¯†åˆ«æ–‡æ¡£ç»“æ„
3. **å†…å®¹æå–**: ä¿ç•™æ ‡é¢˜å±‚æ¬¡å’Œé¡µç ä¿¡æ¯
4. **å‘é‡åŒ–**: ä½¿ç”¨é«˜è´¨é‡åµŒå…¥æ¨¡å‹è½¬æ¢ä¸ºå‘é‡è¡¨ç¤º

### æ£€ç´¢ç­–ç•¥

1. **å‘é‡æ£€ç´¢**: åŸºäºè¯­ä¹‰ç›¸ä¼¼åº¦çš„å¿«é€Ÿæ£€ç´¢
2. **é‡æ’åº**: ä½¿ç”¨é‡æ’åºæ¨¡å‹ä¼˜åŒ–ç»“æœæ’åº
3. **è¿‡æ»¤æœºåˆ¶**: æ”¯æŒåŸºäºå…ƒæ•°æ®çš„ç²¾ç¡®è¿‡æ»¤
4. **ç»“æœèšåˆ**: æ™ºèƒ½åˆå¹¶å’Œå»é‡ç›¸ä¼¼ç»“æœ

### ç­”æ¡ˆç”Ÿæˆ

1. **é—®é¢˜ç†è§£**: è‡ªåŠ¨åˆ†æå’Œåˆ†è§£å¤æ‚é—®é¢˜
2. **ä¸Šä¸‹æ–‡æ„å»º**: åŸºäºæ£€ç´¢ç»“æœæ„å»ºç›¸å…³ä¸Šä¸‹æ–‡
3. **ç­”æ¡ˆåˆæˆ**: ä½¿ç”¨å¤§è¯­è¨€æ¨¡å‹ç”Ÿæˆå‡†ç¡®ç­”æ¡ˆ
4. **å¼•ç”¨æ ‡æ³¨**: è‡ªåŠ¨æ·»åŠ æºæ–‡æ¡£å¼•ç”¨ä¿¡æ¯

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

- **å¹¶å‘å¤„ç†**: æ”¯æŒå¤šçº¿ç¨‹å‘é‡åŒ–ï¼Œæå‡å¤„ç†é€Ÿåº¦
- **æ‰¹é‡æ“ä½œ**: ä¼˜åŒ–å¤§è§„æ¨¡æ–‡æ¡£çš„å¤„ç†æ•ˆç‡
- **ç¼“å­˜æœºåˆ¶**: æ™ºèƒ½ç¼“å­˜å¸¸ç”¨æŸ¥è¯¢ç»“æœ
- **å†…å­˜ç®¡ç†**: è‡ªåŠ¨æ¸…ç†ä¸´æ—¶æ•°æ®ï¼Œé¿å…å†…å­˜æ³„æ¼

## ğŸ”— ç›¸å…³èµ„æº

- [Milvus å®˜æ–¹æ–‡æ¡£](https://milvus.io/docs)
- [SiliconFlow API æ–‡æ¡£](https://docs.siliconflow.cn/)
- [LangChain æ–‡æ¡£](https://python.langchain.com/)

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **APIé…é¢**: æ³¨æ„SiliconFlow APIçš„ä½¿ç”¨é…é¢é™åˆ¶
2. **æ–‡æ¡£æ ¼å¼**: å»ºè®®ä½¿ç”¨ç»“æ„æ¸…æ™°çš„PDFæ–‡æ¡£ä»¥è·å¾—æœ€ä½³æ•ˆæœ
3. **å†…å­˜ä½¿ç”¨**: å¤§æ–‡æ¡£å¤„ç†æ—¶æ³¨æ„å†…å­˜ä½¿ç”¨æƒ…å†µ
4. **ç½‘ç»œè¿æ¥**: ç¡®ä¿ç½‘ç»œè¿æ¥ç¨³å®šä»¥è®¿é—®åœ¨çº¿APIæœåŠ¡

