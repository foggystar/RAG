<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>格式测试</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow">
        <h1 class="text-2xl font-bold mb-4">Markdown 格式测试</h1>
        
        <div class="mb-6">
            <h2 class="text-lg font-semibold mb-2">原始输出（有问题的格式）:</h2>
            <div class="bg-red-50 p-4 rounded border">
                <div id="original-output" class="text-sm"></div>
            </div>
        </div>
        
        <div class="mb-6">
            <h2 class="text-lg font-semibold mb-2">修复后的输出:</h2>
            <div class="bg-green-50 p-4 rounded border">
                <div id="fixed-output" class="text-sm"></div>
            </div>
        </div>
        
        <button onclick="testFormat()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
            测试格式修复
        </button>
    </div>

    <script>
        // Original problematic text from test.md
        const problemText = `#74HC165D 引脚配置与功能详解 74HC165D 概述74HC165D 是一款8位并行输入/串行输出移位寄存器芯片，属于74HC系列高速CMOS逻辑器件。根据文档描述（第1页）：- 它具有串行数据输入(DS)、8个并行数据输入(D0-D7)和两个互补的串行输出(Q7和Q7) 工作电压范围广，输入过压容限可达15V 采用16引脚SO封装(SOT109-1)，工作温度范围-40°C至+125°C

## 引脚配置
74HC165D采用16引脚SO封装，其引脚功能如下表所示（第3页）：

 符号 | 引脚 | 描述 |
|-------|------|------|
| PL | 1 | 异步并行加载输入(低电平有效) |
| CP | 2 | 时钟输入(低到高边沿触发) |
| Q7 | 7 | 最后一级的互补输出 |
| GND | 8 | 地(0V) |
| Q7 | 9 | 最后一级的串行输出 |
| DS | 10 | 串行数据输入 |
| D0-D7 | 11,12,13,14,3,4,5,6 | 并行数据输入(也称为Dn) |
| CE | 15 | 时钟使能输入(低电平有效) |
| VCC | 16 | 正电源电压 |

## 功能框图与引脚图
中包含的功能框图（第1页）和引脚图（第2页）可以更直观地理解芯片的结构：

功能框图：Image
引脚排列图：![](_page_2_Figure_4.jpeg)`;

        // Enhanced markdown to HTML converter (from your fixed code)
        function markdownToHtml(markdown) {
            // First, normalize the text by fixing common formatting issues
            let normalized = markdown
                // Fix title concatenation issues (e.g., "#Title Content" -> "# Title\\n\\nContent")
                .replace(/#([^#\\n]+?)([A-Z][^#]*?)(?=##|$)/g, '# $1\\n\\n$2')
                // Fix missing spaces after list markers
                .replace(/^(\\d+\\.|[-*+])\\s*([^\\s])/gm, '$1 $2')
                // Fix table formatting - ensure proper spacing
                .replace(/\\|\\s*([^|]+?)\\s*\\|/g, '| $1 |')
                // Fix image references that show as "Image"
                .replace(/Image\\s*$/gm, '')
                .replace(/!\\[\\]\\(([^)]+)\\)/g, '![]($1)')
                // Add proper line breaks between sections
                .replace(/([.!?])\\s*([A-Z][^#])/g, '$1\\n\\n$2')
                // Fix numbered lists
                .replace(/^(\\d+)\\.\\s*/gm, '$1. ')
                // Fix bullet lists  
                .replace(/^[-*]\\s*/gm, '- ');

            // Now convert to HTML with improved formatting
            return normalized
                // Headers - with better spacing
                .replace(/^### (.+)$/gm, '<h3 class="text-lg font-bold mt-6 mb-3 text-gray-800 border-b border-gray-200 pb-1">$1</h3>')
                .replace(/^## (.+)$/gm, '<h2 class="text-xl font-bold mt-8 mb-4 text-gray-800 border-b-2 border-blue-200 pb-2">$1</h2>')
                .replace(/^# (.+)$/gm, '<h1 class="text-2xl font-bold mt-10 mb-5 text-gray-900 border-b-2 border-blue-400 pb-3">$1</h1>')
                
                // Tables - improved formatting
                .replace(/^\\|(.+)\\|$/gm, function(match, content) {
                    const cells = content.split('|').map(cell => cell.trim());
                    const isHeader = content.includes('---');
                    if (isHeader) {
                        return ''; // Skip separator rows
                    }
                    const cellTag = cells[0] === '符号' || cells[0] === 'Symbol' ? 'th' : 'td';
                    const cellClass = cellTag === 'th' ? 'bg-blue-50 font-semibold text-blue-900' : 'hover:bg-gray-50';
                    return `<tr>${cells.map(cell => `<${cellTag} class="border border-gray-300 px-3 py-2 ${cellClass}">${cell}</${cellTag}>`).join('')}</tr>`;
                })
                
                // Wrap consecutive table rows in table element
                .replace(/(<tr>.*<\\/tr>\\s*)+/gs, '<table class="w-full border-collapse border-2 border-gray-400 my-4 shadow-sm">$&</table>')
                
                // Bold and italic with better styling
                .replace(/\\*\\*(.+?)\\*\\*/g, '<strong class="font-semibold text-gray-900">$1</strong>')
                .replace(/\\*(.+?)\\*/g, '<em class="italic text-gray-700">$1</em>')
                
                // Code with syntax highlighting style
                .replace(/`([^`]+)`/g, '<code class="bg-blue-50 text-blue-800 px-2 py-1 rounded text-sm font-mono border">$1</code>')
                
                // Images - fix the format and add styling
                .replace(/!\\[\\]\\(([^)]+)\\)/g, '<div class="my-4 text-center"><img src="$1" alt="参考图片" class="max-w-full h-auto mx-auto rounded-lg shadow-md border border-gray-200"/><p class="text-sm text-gray-500 mt-2">参考图片: $1</p></div>')
                .replace(/\\[\\]\\(([^)]+)\\)/g, '<div class="my-4 text-center"><img src="$1" alt="参考图片" class="max-w-full h-auto mx-auto rounded-lg shadow-md border border-gray-200"/><p class="text-sm text-gray-500 mt-2">参考图片: $1</p></div>')
                
                // Links with styling
                .replace(/\\[([^\\]]+)\\]\\(([^)]+)\\)/g, '<a href="$2" class="text-blue-600 hover:text-blue-800 underline font-medium">$1</a>')
                
                // Lists - improved formatting
                .replace(/^(\\d+)\\.\\s+(.+)$/gm, '<li class="mb-1 ml-4">$2</li>')
                .replace(/^-\\s+(.+)$/gm, '<li class="mb-1 ml-4 list-disc">$1</li>')
                
                // Wrap consecutive list items
                .replace(/(<li class="mb-1 ml-4 list-disc">.*<\\/li>\\s*)+/gs, '<ul class="list-disc pl-6 mb-4 space-y-1">$&</ul>')
                .replace(/(<li class="mb-1 ml-4">.*<\\/li>\\s*)+/gs, '<ol class="list-decimal pl-6 mb-4 space-y-1">$&</ol>')
                
                // Paragraphs - better spacing
                .replace(/\\n\\n+/g, '</p><p class="mb-3 leading-relaxed text-gray-700">')
                .replace(/^/, '<p class="mb-3 leading-relaxed text-gray-700">')
                .replace(/$/, '</p>')
                
                // Clean up empty paragraphs and fix nesting
                .replace(/<p class="mb-3 leading-relaxed text-gray-700"><\\/p>/g, '')
                .replace(/<p class="mb-3 leading-relaxed text-gray-700">(<h[1-6]|<table|<ul|<ol)/g, '$1')
                .replace(/(<\\/h[1-6]>|<\\/table>|<\\/ul>|<\\/ol>)<\\/p>/g, '$1')
                
                // Final cleanup
                .replace(/\\n/g, '<br>')
                .replace(/<br>\\s*(<\\/p>|<h[1-6]|<table|<ul|<ol)/g, '$1')
                .replace(/(<\\/h[1-6]>|<\\/table>|<\\/ul>|<\\/ol>)\\s*<br>/g, '$1');
        }

        function testFormat() {
            const originalDiv = document.getElementById('original-output');
            const fixedDiv = document.getElementById('fixed-output');
            
            // Show original (unprocessed)
            originalDiv.innerHTML = problemText.replace(/\\n/g, '<br>');
            
            // Show fixed version
            fixedDiv.innerHTML = markdownToHtml(problemText);
        }
    </script>
</body>
</html>
